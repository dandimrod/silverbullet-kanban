var V=Object.defineProperty;var g=(e,t)=>{for(var r in t)V(e,r,{get:t[r],enumerable:!0})};var v=typeof window>"u"&&typeof globalThis.WebSocketPair>"u";typeof Deno>"u"&&(self.Deno={args:[],build:{arch:"x86_64"},env:{get(){}}});var b=new Map,T=0;function y(e){self.postMessage(e)}v&&(globalThis.syscall=async(e,...t)=>await new Promise((r,n)=>{T++,b.set(T,{resolve:r,reject:n}),y({type:"sys",id:T,name:e,args:t})}));function k(e,t){v&&(self.addEventListener("message",r=>{(async()=>{let n=r.data;switch(n.type){case"inv":{let o=e[n.name];if(!o)throw new Error(`Function not loaded: ${n.name}`);try{let i=await Promise.resolve(o(...n.args||[]));y({type:"invr",id:n.id,result:i})}catch(i){console.error("An exception was thrown as a result of invoking function",n.name,"error:",i.message),y({type:"invr",id:n.id,error:i.message})}}break;case"sysr":{let o=n.id,i=b.get(o);if(!i)throw Error("Invalid request id");b.delete(o),n.error?i.reject(new Error(n.error)):i.resolve(n.result)}break}})().catch(console.error)}),y({type:"manifest",manifest:t}))}function N(e){let t=atob(e),r=t.length,n=new Uint8Array(r);for(let o=0;o<r;o++)n[o]=t.charCodeAt(o);return n}function M(e){typeof e=="string"&&(e=new TextEncoder().encode(e));let t="",r=e.byteLength;for(let n=0;n<r;n++)t+=String.fromCharCode(e[n]);return btoa(t)}async function W(e,t){if(typeof e!="string"){let r=new Uint8Array(await e.arrayBuffer()),n=r.length>0?M(r):void 0;t={method:e.method,headers:Object.fromEntries(e.headers.entries()),base64Body:n},e=e.url}return syscall("sandboxFetch.fetch",e,t)}globalThis.nativeFetch=globalThis.fetch;function I(){globalThis.fetch=async function(e,t){let r=t&&t.body?M(new Uint8Array(await new Response(t.body).arrayBuffer())):void 0,n=await W(e,t&&{method:t.method,headers:t.headers,base64Body:r});return new Response(n.base64Body?N(n.base64Body):null,{status:n.status,headers:n.headers})}}v&&I();function $(e,t){return C(e,r=>r.type===t)}function C(e,t){if(t(e))return[e];let r=[];if(e.children)for(let n of e.children)r=[...r,...C(n,t)];return r}function x(e){if(!e)return"";let t=[];if(e.text!==void 0)return e.text;for(let r of e.children)t.push(x(r));return t.join("")}function w(e,t=!0){if($(e,"\u26A0").length>0)throw new Error(`Parse error in: ${x(e)}`);if(e.text!==void 0)return e.text;let n=[e.type];for(let o of e.children)o.type&&!o.type.endsWith("Mark")&&n.push(w(o,t)),o.text&&(t&&o.text.trim()||!t)&&n.push(o.text);return n}typeof self>"u"&&(self={syscall:()=>{throw new Error("Not implemented here")}});function s(e,...t){return globalThis.syscall(e,...t)}var p={};g(p,{parseMarkdown:()=>_,renderParseTree:()=>Y});function _(e){return s("markdown.parseMarkdown",e)}function Y(e){return s("markdown.renderParseTree",e)}var f={};g(f,{applyAttributeExtractors:()=>Z,getEnv:()=>ne,getMode:()=>oe,getSpaceConfig:()=>ee,getVersion:()=>ie,invokeCommand:()=>J,invokeFunction:()=>H,invokeSpaceFunction:()=>X,listCommands:()=>z,listSyscalls:()=>G,reloadConfig:()=>re,reloadPlugs:()=>te});function H(e,...t){return s("system.invokeFunction",e,...t)}function J(e,t){return s("system.invokeCommand",e,t)}function z(){return s("system.listCommands")}function G(){return s("system.listSyscalls")}function X(e,...t){return s("system.invokeSpaceFunction",e,...t)}function Z(e,t,r){return s("system.applyAttributeExtractors",e,t,r)}async function ee(e,t){return await s("system.getSpaceConfig",e)??t}function te(){return s("system.reloadPlugs")}function re(){return s("system.reloadConfig")}function ne(){return s("system.getEnv")}function oe(){return s("system.getMode")}function ie(){return s("system.getVersion")}var P={};g(P,{listLanguages:()=>ue,parseLanguage:()=>le});function le(e,t){return s("language.parseLanguage",e,t)}function ue(){return s("language.listLanguages")}var d={};g(d,{parse:()=>ge,stringify:()=>ye});function ge(e){return s("yaml.parse",e)}function ye(e){return s("yaml.stringify",e)}function E(e){let t={querySource:""},[r,n,...o]=e;if(r!=="Query")throw new Error(`Expected query type, got ${r}`);t.querySource=n[1];for(let i of o){let[l]=i;switch(l){case"WhereClause":{t.filter?t.filter=["and",t.filter,a(i[2])]:t.filter=a(i[2]);break}case"OrderClause":{t.orderBy||(t.orderBy=[]);for(let c of i.slice(2))if(c[0]==="OrderBy"){let u=c[1][1];c[2]?t.orderBy.push({expr:a(u),desc:c[2][1][1]==="desc"}):t.orderBy.push({expr:a(u),desc:!1})}break}case"LimitClause":{t.limit=a(i[2][1]);break}case"SelectClause":{for(let c of i.slice(2))c[0]==="Select"&&(t.select||(t.select=[]),c.length===2?t.select.push({name:m(c[1][1])}):t.select.push({name:m(c[3][1]),expr:a(c[1])}));break}case"RenderClause":{let c=i.find(u=>u[0]==="PageRef");t.render=c[1].slice(2,-2),t.renderAll=!!i.find(u=>u[0]==="all");break}default:throw new Error(`Unknown clause type: ${l}`)}}return t}function m(e){return e.startsWith("`")&&e.endsWith("`")?e.slice(1,-1):e}function a(e){if(["LVal","Expression","Value"].includes(e[0]))return a(e[1]);switch(e[0]){case"Attribute":return["attr",a(e[1]),m(e[3][1])];case"Identifier":return["attr",m(e[1])];case"String":return["string",e[1].slice(1,-1)];case"Number":return["number",+e[1]];case"Bool":return["boolean",e[1][1]==="true"];case"null":return["null"];case"Regex":return["regexp",e[1].slice(1,-1),"i"];case"List":{let t=[];for(let r of e.slice(2))r[0]==="Expression"&&t.push(r);return["array",t.map(a)]}case"Object":{let t=[];for(let r of e.slice(2)){if(typeof r=="string")continue;let[n,o,i,l]=r;t.push([o[1].slice(1,-1),a(l)])}return["object",t]}case"BinExpression":{let t=a(e[1]),r=e[2][0]==="InKW"?"in":e[2].trim(),n=a(e[3]);return[r,t,n]}case"LogicalExpression":{let t=a(e[1]),r=e[2],n=a(e[3]);return[r[1],t,n]}case"ParenthesizedExpression":return a(e[2]);case"Call":{let t=m(e[1][1]),r=[];for(let n of e.slice(2))n[0]==="Expression"&&r.push(n);return["call",t,r.map(a)]}case"UnaryExpression":{if(e[1][0]==="NotKW"||e[1][0]==="!")return["not",a(e[2])];if(e[1][0]==="-")return["-",a(e[2])];throw new Error(`Unknown unary expression: ${e[1][0]}`)}case"TopLevelVal":return["attr"];case"GlobalIdentifier":return["global",e[1].substring(1)];case"TernaryExpression":{let[t,r,n,o,i,l]=e;return["?",a(r),a(o),a(l)]}case"QueryExpression":return["query",E(e[2])];case"PageRef":return["pageref",e[1].slice(2,-2)];default:throw new Error(`Not supported: ${e[0]}`)}}async function A(e){let t=w(await P.parseLanguage("query",e));return E(t[1])}var h=class{constructor(t,r={}){this.maxSize=t;this.map=new Map(Object.entries(r))}map;set(t,r,n){let o={value:r,la:Date.now()};if(n){let i=this.map.get(t);i?.expTimer&&clearTimeout(i.expTimer),o.expTimer=setTimeout(()=>{this.map.delete(t)},n)}if(this.map.size>=this.maxSize){let i=this.getOldestKey();this.map.delete(i)}this.map.set(t,o)}get(t){let r=this.map.get(t);if(r)return r.la=Date.now(),r.value}remove(t){this.map.delete(t)}toJSON(){return Object.fromEntries(this.map.entries())}getOldestKey(){let t,r;for(let[n,o]of this.map.entries())(!r||o.la<r)&&(t=n,r=o.la);return t}};var Xe=new h(50);function j(e,t,r){return f.invokeFunction("index.getObjectByRef",e,t,r)}async function K(e){return e?await j(e,"page",e)||{ref:e,name:e,tags:["page"],lastModified:"",created:""}:{ref:"",name:"",tags:["page"],lastModified:"",created:""}}async function R(e,t){let r=await f.getSpaceConfig(),n=await K(t);try{let o=await d.parse(e),i=await A(o.query),l=await f.invokeFunction("query.renderQuery",i,{page:n,config:r}),c={};if(o.template)for(let u of l){let D=await A(`task where ref = '${u.ref}' render [[${o.template}]]`),L=await f.invokeFunction("query.renderQuery",D,{page:n,config:r}),B=await p.parseMarkdown(L),Q=await p.renderParseTree(B);c[u.ref]=Q}return{html:`
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jkanban@1.3.1/dist/jkanban.min.css">
      <style>
        html[data-theme=dark] {
          color-scheme: dark;
          --root-background-color: #111;
          --root-color: #fff;
          --top-background-color: #262626;
        }
        html {
          --root-background-color: #fff;
          --root-color: inherit;
          --top-background-color: #e1e1e1;
          --ui-font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji"
        }
        body{
          margin:0;
          background-color:var(--root-background-color);
          color:var(--root-color);
          font-family: var(--ui-font);
        }
        .kanban-board{
          background: var(--top-background-color);
        }
        .kanban-item{
          background: var(--root-background-color);
        }
      </style>
      <div id="kanban"></div>`,script:`
      loadJsByUrl("https://cdn.jsdelivr.net/npm/jkanban@1.3.1/dist/jkanban.min.js").then(() => {
        const data = ${JSON.stringify(Te(l,o.columns,c))};
        const kanban = new jKanban({
          element: '#kanban',
          boards:data,
          ...${JSON.stringify(o.options||{})}
        });

        updateHeight();
      });
      `}}catch(o){return{markdown:`**Error:** ${o.message}`}}}function Te(e,t,r){let n=t;return t||(n=e.reduce((o,i)=>(i.state&&!o.find(l=>l.title===i.state)&&o.push({title:i.state}),o),[])),n.map(o=>({id:o.id??o.title,title:o.title,class:o.class,item:e.filter(i=>i.state===(o.id??o.title)).map(i=>({id:i.ref,title:r[i.ref]??i.text}))}))}var U={kanbanWidget:R},q={name:"kanban",functions:{kanbanWidget:{path:"./kanban.ts:widget",codeWidget:"kanban"}},assets:{}},Ot={manifest:q,functionMapping:U};k(U,q);export{Ot as plug};
